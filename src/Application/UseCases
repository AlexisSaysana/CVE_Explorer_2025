// UseCases module
// This file provides application-level helpers and a use-case-compatible API
// It must not access the DOM directly â€” UI layer handles DOM interactions.

import { fetchNvdCve, fetchEpssCve, checkKevCve, getNvdUrl } from '../Infrastructure/Cve.js';

export function isValidCveCode(cveCode) {
    if (typeof cveCode !== 'string' || cveCode.trim() === '') return false;
    const cvePattern = /^CVE-\d{4}-\d{4,}$/i;
    return cvePattern.test(cveCode.trim());
}

async function analyzeCve(cveId) {
    if (!isValidCveCode(cveId)) {
        throw new Error('Invalid CVE identifier. Expected format: CVE-YYYY-NNNN');
    }

    const [nvdResult, epssResult, kevResult] = await Promise.all([
        fetchNvdCve(cveId).catch(err => ({ error: String(err) })),
        fetchEpssCve(cveId).catch(() => null),
        checkKevCve(cveId).catch(() => null),
    ]);

    const data = {
        id: cveId,
        nvd: nvdResult && !nvdResult.error ? nvdResult : null,
        epss: epssResult || null,
        kev: kevResult || null,
        urls: { nvd: getNvdUrl(cveId) },
    };

    data.risk = (function calc(nvd, epss, kev) {
        let score = 0;
        if (nvd && nvd.cvssScore && typeof nvd.cvssScore.baseScore === 'number') score += nvd.cvssScore.baseScore;
        if (epss && typeof epss.score === 'number') score += epss.score * 5;
        if (kev) score += 3;
        const normalizedScore = Math.min(10, Math.round((score / 12) * 10));
        let level = 'Low';
        if (normalizedScore >= 8) level = 'Critical';
        else if (normalizedScore >= 6) level = 'High';
        else if (normalizedScore >= 4) level = 'Medium';
        return { score: normalizedScore, level };
    })(data.nvd, data.epss, data.kev);

    return data;
}

export const analyzeCveUseCase = {
    execute: analyzeCve,
};

export default analyzeCveUseCase;
