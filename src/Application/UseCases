// UseCases module
// This file provides application-level helpers and a use-case-compatible API
// It must not access the DOM directly â€” UI layer handles DOM interactions.

import { fetchNvdCve, fetchEpssCve, checkKevCve, getNvdUrl } from '../Infrastructure/Cve.js';
import { CVE_NOT_FOUND, INVALID_CVE_FORMAT } from './messages.js';

export function isValidCveCode(cveCode) {
    if (typeof cveCode !== 'string' || cveCode.trim() === '') return false;
    const cvePattern = /^CVE-\d{4}-\d{4,}$/i;
    return cvePattern.test(cveCode.trim());
}

async function analyzeCve(cveId) {
    if (!isValidCveCode(cveId)) {
        throw new Error(INVALID_CVE_FORMAT);
    }

    const [nvdResult, epssResult, kevResult] = await Promise.all([
        fetchNvdCve(cveId).catch(err => ({ error: String(err) })),
        fetchEpssCve(cveId).catch(() => null),
        checkKevCve(cveId).catch(() => null),
    ]);

    // If NVD returned null, the CVE probably does not exist -> surface a user-facing error
    if (!nvdResult || (nvdResult && nvdResult.error)) {
        throw new Error(CVE_NOT_FOUND);
    }

    const data = {
        id: cveId,
        nvd: nvdResult && !nvdResult.error ? nvdResult : null,
        epss: epssResult || null,
        kev: kevResult || null,
        urls: { nvd: getNvdUrl(cveId) },
    };

    // Determine risk using available numeric values
    const risk = (function calc(nvd, epss, kev) {
        let score = 0;
        // nvd.cvssScore might be a number or an object with baseScore
        const nvdScore = nvd?.cvssScore?.baseScore ?? nvd?.cvssScore ?? null;
        if (typeof nvdScore === 'number') score += nvdScore;
        if (epss && typeof epss.score === 'number') score += epss.score * 5;
        if (kev) score += 3;
        const normalizedScore = Math.min(10, Math.round((score / 12) * 10));
        let level = 'Low';
        if (normalizedScore >= 8) level = 'Critical';
        else if (normalizedScore >= 6) level = 'High';
        else if (normalizedScore >= 4) level = 'Medium';
        return { score: normalizedScore, level };
    })(data.nvd, data.epss, data.kev);

    // Flatten the shape to match what the UI components expect
    const flattened = {
        id: data.id,
        description: data.nvd?.description || data.nvd?.technical?.description || null,
        published: data.nvd?.published || data.nvd?.technical?.published || null,
        // Normalize CVSS to an object with baseScore and vector
        cvssScore: (function () {
            const raw = data.nvd?.cvssScore ?? null;
            if (!raw) return null;
            if (typeof raw === 'number') return { baseScore: raw, vector: data.nvd?.cvssVector || null };
            if (typeof raw === 'object' && raw.baseScore !== undefined) return raw;
            return null;
        })(),
        // EPSS can be null or {score}
        epssScore: data.epss?.score ?? null,
        epss: data.epss || null,
        cwe: data.nvd?.cwe || [],
        affectedProducts: data.nvd?.affectedProducts || [],
        references: data.nvd?.references || [],
        kev: data.kev ? (typeof data.kev === 'boolean' ? { exploited: data.kev } : data.kev) : null,
        urls: data.urls,
        risk,
    };

    return flattened;
}

export const analyzeCveUseCase = {
    execute: analyzeCve,
};

export default analyzeCveUseCase;
